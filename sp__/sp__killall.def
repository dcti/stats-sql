#!/usr/local/bin/sqsh -i

\set procedure=sp__killall
use sybsystemprocs
go

print "Creating procedure $procedure"
go
if object_id("$procedure") is not NULL
begin
	drop procedure $procedure
end
go
create procedure $procedure
(	@target  varchar(30) = null
)
as
begin
	-- $Id: sp__killall.def,v 1.2 2001/12/21 21:17:45 decibel Exp $
	/*
	** sp__killall
	** -----------
	**
	** Mimic UNIX's killall(1M) command:  Kill all spids like "@target + %".
	** Sybase, in their infinite wisdom, decided not to allow a variable as 
	** a valid argument to SQLSvr's kill command...  No wounder their stock
	** made a steady decline from $60/shr to $8/shr over the past 2 yrs...
	**
	** FJ Lundy, Hiway Technologies Inc., 8/98
	*/

	/*
	** Usage?
	*/
	if (@target = null)
	begin
		print ""
		print "USAGE  :  sp__killall <progname>"
		print ""
		print "AUTHOR :  FJ Lundy, Hiway Technologies, 8/98"
		print "VERSION:  v1.2"
		print ""
		return(-1)
	end

	/*
	** Build the list of processes to kill
	*/
	select @target = @target + "%"

	select "kill " + convert(char, spid) 
	from   master..sysprocesses
	where  program_name like @target

	/*
	** Done
	*/
	return(0)

end
go

grant execute on $procedure to public
go
