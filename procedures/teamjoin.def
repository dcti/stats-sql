-- $Id: teamjoin.def,v 1.5 2000/08/22 09:53:27 decibel Exp $

\set procedure=p_teamjoin

if ( "${1}" = "" )
begin
	print "Database not specified! Using 'stats' as default!"
	use stats
end
go
if ( "${1}" != "" )
begin
	use ${1}
end
go

if (object_id("$procedure") is not null)
begin
        print "Dropping procedure $procedure"
        drop procedure $procedure
end
go

\echo "Creating procedure $procedure"
create procedure $procedure
(
	@id int = 0,		/* Participant ID */
	@team int = null	/* Team to join */
)
as

	/* Error checking */
	if @id = 0
	begin
		raiserror 99999 "participant ID not specified"
		return -5
	end

	if @team = null
	begin
		raiserror 99999 "team ID not specified"
		return -5
	end

	if @team != 0
		if not exists (select team from Stats_Team where team = @team) 
		begin
			raiserror 99998 "invalid team specified"
			return -6
		end

	/* Grab just the date portion of today */
	declare @date smalldatetime
	select @date = getdate()
	exec sp__date_only @date output

	/* Update the entry for the previous team, if there is one */
	update jcn_Team_Joins2
		set LEAVE_DATE = @date,
			LEAVE_TEAM_ID = @team
	where ID = @id
		and LEAVE_DATE = null
	-- note that there should always be 1 or 0 records where LEAVE_DATE = null
	-- for a given participant

	/* If the participant already has a record for today, nuke it */
	delete jcn_Team_Joins2
	where ID = @id
		and JOIN_DATE = @date

	/* Insert a new record, unless we're joining 'team 0' */
	if @team != 0
	begin
		insert jcn_Team_Joins2 (ID, TEAM_ID, JOIN_DATE)
		values (@id, @team, @date)
	end

	/* Update Stats_Participant (redundant info; should eventually go away) */
	update Stats_Participant
		set team = @team
	where ID = @id

	return

go

grant execute on $procedure to public
go

