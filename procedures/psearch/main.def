# $Id: main.def,v 1.3 2000/01/27 02:31:54 decibel Exp $

use stats
go

\set procedure=p_psearch

if (object_id("$procedure") is not NULL)
begin
	revoke exec on $procedure to public
	print "Dropping procedure ${procedure}"
	drop procedure $procedure
end
go

print "Creating procedure ${procedure}"
go

create procedure $procedure
	@project		varchar(10) = null,	/* Contest to look at */
	@searchtext		varchar(255) = null,	/* Text to search for */
	@maxrows		int = 50,		/* Max rows to return */
	@escapewildcards	bit = 1			/* 1: escape wildcard characters in @searchtext */
as
begin
	set nocount on
	set rowcount 0

	declare @rows		int,		
		@maxworkrows	int,		/* Maximum rows for worktable */
		@pattern	varchar(255),	/* Search pattern to use */
		@procname	varchar(30)	/* Name of the procedure to run */

	/* Error checking */

	/* Make sure all required parameters were specified */
	if ( (@project = null) or (@searchtext = null) )
	begin
		raiserror 99999 "Not enough parameters"
		print "usage:"
		print "	$procedure project, searchtext, maxrows, escapewildcards"
		print "where:"
		print "	project is project to look at"
		print " searchtext is the email to search for"
		print " maxrows is the maximum number of rows to return"
		print " escapewildcards is set to 1 if you want to escape wildcards in searchtext"
		print "		(%, -) [default], or 0 if you do not want to escape them"
		return -5
	end

	/* Build the procedure name */
	select @procname = "${procedure}_" + @project
	
	/* See if the silly procedure exists */
	if (object_id(@procname) is NULL)
	begin
		raiserror 99999 "Procedure '%1!' does not exist!", @procname
		return -1
	end


	create table #psearch
	(
		id	int
	)

	select	@rows = 0,
		@maxworkrows = @maxrows * 0	-- maxworkrows must be 0 when sorting by rank

	-- See if we should escape the wildcards
	if (@escapewildcards = 1)
	begin
		exec p_escape_wildcards @searchtext, @pattern output
	end
	else
	begin
		select @pattern = @searchtext
	end

	-- Do the search
	select @pattern = @pattern + '%'

	if charindex('@', @pattern) = 0
	begin
		set rowcount @maxworkrows

		insert #psearch (id)
			select id
			from STATS_Participant
			where email like @pattern

		select @rows = @@rowcount

		set rowcount 0
	end
	-- If we didn't get any rows back (maybe because we didn't even search), search again
	if @rows = 0
	begin
		select @pattern = '%' + @pattern

		set rowcount @maxworkrows

		insert #psearch
			select id
			from STATS_Participant
			where email like @pattern

		select @rows = @@rowcount

		set rowcount 0
	end

	-- Actually execute the procedure	
	set rowcount @maxrows
	set nocount off
	exec @procname
	set nocount on
	set rowcount 0

	drop table #psearch

        return
end
go
grant exec on $procedure to public
go
